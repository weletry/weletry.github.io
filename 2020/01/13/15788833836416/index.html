<!DOCTYPE html>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="weletry&#39;s blog">
  <meta name="keyword" content="hexo-theme, vuejs">
  
    <link rel="shortcut icon" href="/css/images/logo.png">
  
  <title>
    
      Weletry&#39;s Blog
    
  </title>
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.css" rel="stylesheet">
  <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
    <!-- css('css/plugins/gitment.css') -->
    <link rel="stylesheet" href="/css/plugins/gitment.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/geopattern/1.2.3/js/geopattern.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/nprogress/0.2.0/nprogress.min.js"></script>
  
  
    <script src="/js/gitment.js"></script>
  
  
  
    <!-- MathJax support START -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- MathJax support END -->
  


</head>
<div class="wechat-share">
  <img src="/css/images/logo.png">
</div>

  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <span>Weletry's Blog</span>
    </a>
    <ul class="right-list">
      
        <li class="list-item">
          
            <a href="/" class="item-link">Home</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/tags/" class="item-link">Tags</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/archives/" class="item-link">Archives</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/project/" class="item-link">Projects</a>
          
        </li>
      
        <li class="list-item">
          
            <a href="/about/" class="item-link">About</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/" class="menu-link">Home</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">Tags</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/archives/" class="menu-link">Archives</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/project/" class="menu-link">Projects</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">About</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2></h2>
  <p class="post-date">2020-01-13</p>
  <div class="arrow-down">
    <a href="javascript:;"></a>
  </div>
</div>
<main class="app-body flex-box">
  <!-- Article START -->
  <article class="post-article">
    <section class="markdown-content"><p># </p>
<h1 id="01-搭建K8s集群-无需科学上网"><a href="#01-搭建K8s集群-无需科学上网" class="headerlink" title="01 搭建K8s集群[无需科学上网]"></a>01 搭建K8s集群[无需科学上网]</h1><blockquote>
<p><code>官网</code>：<a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectl</a></p>
<p><code>GitHub</code>：<a href="https://github.com/kubernetes/kubeadm" target="_blank" rel="noopener">https://github.com/kubernetes/kubeadm</a></p>
<p><code>课程中</code>：使用kubeadm搭建一个3台机器组成的k8s集群，1台master节点，2台worker节点</p>
<p><strong>如果大家机器配置不够，也可以使用在线的，或者minikube的方式或者1个master和1个worker</strong></p>
<p><code>配置要求</code>：</p>
<ul>
<li>One or more machines running one of:<ul>
<li>Ubuntu 16.04+</li>
<li>Debian 9+</li>
<li>CentOS 7【课程中使用】</li>
<li>Red Hat Enterprise Linux (RHEL) 7</li>
<li>Fedora 25+</li>
<li>HypriotOS v1.0.1+</li>
<li>Container Linux (tested with 1800.6.0)</li>
</ul>
</li>
<li>2 GB or more of RAM per machine (any less will leave little room for your apps)</li>
<li>2 CPUs or more</li>
<li>Full network connectivity between all machines in the cluster (public or private network is fine)</li>
<li>Unique hostname, MAC address, and product_uuid for every node. See here for more details.</li>
<li>Certain ports are open on your machines. See here for more details.</li>
<li>Swap disabled. You <strong>MUST</strong> disable swap in order for the kubelet to work properly.</li>
</ul>
</blockquote>
<h2 id="1-1-版本统一"><a href="#1-1-版本统一" class="headerlink" title="1.1 版本统一"></a>1.1 版本统一</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Docker       18.09.0</span><br><span class="line">---</span><br><span class="line">kubeadm-1.14.0-0 </span><br><span class="line">kubelet-1.14.0-0 </span><br><span class="line">kubectl-1.14.0-0</span><br><span class="line">---</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.14.0</span><br><span class="line">k8s.gcr.io/pause:3.1</span><br><span class="line">k8s.gcr.io/etcd:3.3.10</span><br><span class="line">k8s.gcr.io/coredns:1.3.1</span><br><span class="line">---</span><br><span class="line">calico:v3.9</span><br></pre></td></tr></table></figure>

<h2 id="1-2-准备3台centos"><a href="#1-2-准备3台centos" class="headerlink" title="1.2 准备3台centos"></a>1.2 准备3台centos</h2><p>大家根据自己的情况来准备centos7的虚拟机。</p>
<p>要保证彼此之间能够ping通，也就是处于同一个网络中，虚拟机的配置要求上面也描述咯。</p>
<h2 id="1-3-更新并安装依赖"><a href="#1-3-更新并安装依赖" class="headerlink" title="1.3 更新并安装依赖"></a>1.3 更新并安装依赖</h2><blockquote>
<p>3台机器都需要执行</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y update</span><br><span class="line">yum install -y conntrack ipvsadm ipset jq sysstat curl iptables libseccomp</span><br></pre></td></tr></table></figure>

<h2 id="1-4-安装Docker"><a href="#1-4-安装Docker" class="headerlink" title="1.4 安装Docker"></a>1.4 安装Docker</h2><blockquote>
<p>根据之前学习的Docker方式[Docker第一节课的笔记中也有这块的说明]</p>
<p>在每一台机器上都安装好Docker，版本为18.09.0</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> 01 安装必要的依赖</span><br><span class="line"><span class="meta">&gt;</span> 	sudo yum install -y yum-utils \</span><br><span class="line"><span class="meta">&gt;</span>     device-mapper-persistent-data \</span><br><span class="line"><span class="meta">&gt;</span>     lvm2</span><br><span class="line"><span class="meta">&gt;</span>     </span><br><span class="line"><span class="meta">&gt;</span>     </span><br><span class="line"><span class="meta">&gt;</span> 02 设置docker仓库</span><br><span class="line"><span class="meta">&gt;</span> 	sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"><span class="meta">&gt;</span> 	</span><br><span class="line"><span class="meta">&gt;</span> 【设置要设置一下阿里云镜像加速器】</span><br><span class="line"><span class="meta">&gt;</span> sudo mkdir -p /etc/docker</span><br><span class="line"><span class="meta">&gt;</span> sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span><br><span class="line"><span class="meta">&gt;</span> &#123;</span><br><span class="line"><span class="meta">&gt;</span>   "registry-mirrors": ["这边替换成自己的实际地址"]</span><br><span class="line"><span class="meta">&gt;</span> &#125;</span><br><span class="line"><span class="meta">&gt;</span> EOF</span><br><span class="line"><span class="meta">&gt;</span> sudo systemctl daemon-reload</span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> 03 安装docker</span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span>   yum install -y docker-ce-18.09.0 docker-ce-cli-18.09.0 containerd.io</span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> 04 启动docker</span><br><span class="line"><span class="meta">&gt;</span> 	sudo systemctl start docker &amp;&amp; sudo systemctl enable docker</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="1-5-修改hosts文件"><a href="#1-5-修改hosts文件" class="headerlink" title="1.5 修改hosts文件"></a>1.5 修改hosts文件</h2><blockquote>
<p>(1)master</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 设置master的hostname，并且修改hosts文件</span><br><span class="line">sudo hostnamectl set-hostname m</span><br><span class="line"></span><br><span class="line">vi /etc/hosts</span><br><span class="line">192.168.8.51 m</span><br><span class="line">192.168.8.61 w1</span><br><span class="line">192.168.8.62 w2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2)两个worker</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 设置worker01/02的hostname，并且修改hosts文件</span><br><span class="line">sudo hostnamectl set-hostname w1</span><br><span class="line">sudo hostnamectl set-hostname w2</span><br><span class="line"></span><br><span class="line">vi /etc/hosts</span><br><span class="line">192.168.8.51 m</span><br><span class="line">192.168.8.61 w1</span><br><span class="line">192.168.8.62 w2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(3)使用ping测试一下</p>
</blockquote>
<h2 id="1-6-系统基础前提配置"><a href="#1-6-系统基础前提配置" class="headerlink" title="1.6 系统基础前提配置"></a>1.6 系统基础前提配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> (1)关闭防火墙</span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> (2)关闭selinux</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> (3)关闭swap</span><br><span class="line">swapoff -a</span><br><span class="line">sed -i '/swap/s/^\(.*\)$/#\1/g' /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> (4)配置iptables的ACCEPT规则</span><br><span class="line">iptables -F &amp;&amp; iptables -X &amp;&amp; iptables -F -t nat &amp;&amp; iptables -X -t nat &amp;&amp; iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> (5)设置系统参数</span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br></pre></td></tr></table></figure>

<h2 id="1-7-Installing-kubeadm-kubelet-and-kubectl"><a href="#1-7-Installing-kubeadm-kubelet-and-kubectl" class="headerlink" title="1.7 Installing kubeadm, kubelet and kubectl"></a>1.7 Installing kubeadm, kubelet and kubectl</h2><blockquote>
<p>(1)配置yum源</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2)安装kubeadm&amp;kubelet&amp;kubectl</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubeadm-1.14.0-0 kubelet-1.14.0-0 kubectl-1.14.0-0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(3)docker和k8s设置同一个cgroup</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> docker</span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line">    "exec-opts": ["native.cgroupdriver=systemd"],</span><br><span class="line">    </span><br><span class="line">systemctl restart docker</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span> kubelet，这边如果发现输出directory not exist，也说明是没问题的，大家继续往下进行即可</span><br><span class="line">sed -i "s/cgroup-driver=systemd/cgroup-driver=cgroupfs/g" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line">	</span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>

<h2 id="1-8-proxy-pause-scheduler等国内镜像"><a href="#1-8-proxy-pause-scheduler等国内镜像" class="headerlink" title="1.8 proxy/pause/scheduler等国内镜像"></a>1.8 proxy/pause/scheduler等国内镜像</h2><blockquote>
<p>(1)查看kubeadm使用的镜像</p>
<p>kubeadm config images list</p>
<p>可以发现这里都是国外的镜像</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">k8s.gcr.io/kube-apiserver:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.14.0</span><br><span class="line">k8s.gcr.io/pause:3.1</span><br><span class="line">k8s.gcr.io/etcd:3.3.10</span><br><span class="line">k8s.gcr.io/coredns:1.3.1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2)解决国外镜像不能访问的问题</p>
</blockquote>
<ul>
<li>创建kubeadm.sh脚本，用于拉取镜像/打tag/删除原有镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">KUBE_VERSION=v1.14.0</span><br><span class="line">KUBE_PAUSE_VERSION=3.1</span><br><span class="line">ETCD_VERSION=3.3.10</span><br><span class="line">CORE_DNS_VERSION=1.3.1</span><br><span class="line"></span><br><span class="line">GCR_URL=k8s.gcr.io</span><br><span class="line">ALIYUN_URL=registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">images=(kube-proxy:$&#123;KUBE_VERSION&#125;</span><br><span class="line">kube-scheduler:$&#123;KUBE_VERSION&#125;</span><br><span class="line">kube-controller-manager:$&#123;KUBE_VERSION&#125;</span><br><span class="line">kube-apiserver:$&#123;KUBE_VERSION&#125;</span><br><span class="line">pause:$&#123;KUBE_PAUSE_VERSION&#125;</span><br><span class="line">etcd:$&#123;ETCD_VERSION&#125;</span><br><span class="line">coredns:$&#123;CORE_DNS_VERSION&#125;)</span><br><span class="line"></span><br><span class="line">for imageName in $&#123;images[@]&#125; ; do</span><br><span class="line">  docker pull $ALIYUN_URL/$imageName</span><br><span class="line">  docker tag  $ALIYUN_URL/$imageName $GCR_URL/$imageName</span><br><span class="line">  docker rmi $ALIYUN_URL/$imageName</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li>运行脚本和查看镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 运行脚本</span><br><span class="line">sh ./kubeadm.sh</span><br><span class="line"></span><br><span class="line"># 查看镜像</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<ul>
<li>将这些镜像推送到自己的阿里云仓库【可选，根据自己实际的情况】</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 登录自己的阿里云仓库</span><br><span class="line">docker login --username=xxx registry.cn-hangzhou.aliyuncs.com</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">KUBE_VERSION=v1.14.0</span><br><span class="line">KUBE_PAUSE_VERSION=3.1</span><br><span class="line">ETCD_VERSION=3.3.10</span><br><span class="line">CORE_DNS_VERSION=1.3.1</span><br><span class="line"></span><br><span class="line">GCR_URL=k8s.gcr.io</span><br><span class="line">ALIYUN_URL=xxx</span><br><span class="line"></span><br><span class="line">images=(kube-proxy:$&#123;KUBE_VERSION&#125;</span><br><span class="line">kube-scheduler:$&#123;KUBE_VERSION&#125;</span><br><span class="line">kube-controller-manager:$&#123;KUBE_VERSION&#125;</span><br><span class="line">kube-apiserver:$&#123;KUBE_VERSION&#125;</span><br><span class="line">pause:$&#123;KUBE_PAUSE_VERSION&#125;</span><br><span class="line">etcd:$&#123;ETCD_VERSION&#125;</span><br><span class="line">coredns:$&#123;CORE_DNS_VERSION&#125;)</span><br><span class="line"></span><br><span class="line">for imageName in $&#123;images[@]&#125; ; do</span><br><span class="line">  docker tag $GCR_URL/$imageName $ALIYUN_URL/$imageName</span><br><span class="line">  docker push $ALIYUN_URL/$imageName</span><br><span class="line">  docker rmi $ALIYUN_URL/$imageName</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<blockquote>
<p>运行脚本 sh ./kubeadm-push-aliyun.sh</p>
</blockquote>
<h2 id="1-9-kube-init初始化master"><a href="#1-9-kube-init初始化master" class="headerlink" title="1.9 kube init初始化master"></a>1.9 kube init初始化master</h2><blockquote>
<p>(1)kube init流程</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">01-进行一系列检查，以确定这台机器可以部署kubernetes</span><br><span class="line"></span><br><span class="line">02-生成kubernetes对外提供服务所需要的各种证书可对应目录</span><br><span class="line">/etc/kubernetes/pki/*</span><br><span class="line"></span><br><span class="line">03-为其他组件生成访问kube-ApiServer所需的配置文件</span><br><span class="line">    ls /etc/kubernetes/</span><br><span class="line">    admin.conf  controller-manager.conf  kubelet.conf  scheduler.conf</span><br><span class="line">    </span><br><span class="line">04-为 Master组件生成Pod配置文件。</span><br><span class="line">    ls /etc/kubernetes/manifests/*.yaml</span><br><span class="line">    kube-apiserver.yaml </span><br><span class="line">    kube-controller-manager.yaml</span><br><span class="line">    kube-scheduler.yaml</span><br><span class="line">    </span><br><span class="line">05-生成etcd的Pod YAML文件。</span><br><span class="line">    ls /etc/kubernetes/manifests/*.yaml</span><br><span class="line">    kube-apiserver.yaml </span><br><span class="line">    kube-controller-manager.yaml</span><br><span class="line">    kube-scheduler.yaml</span><br><span class="line">	etcd.yaml</span><br><span class="line">	</span><br><span class="line">06-一旦这些 YAML 文件出现在被 kubelet 监视的/etc/kubernetes/manifests/目录下，kubelet就会自动创建这些yaml文件定义的pod，即master组件的容器。master容器启动后，kubeadm会通过检查localhost：6443/healthz这个master组件的健康状态检查URL，等待master组件完全运行起来</span><br><span class="line"></span><br><span class="line">07-为集群生成一个bootstrap token</span><br><span class="line"></span><br><span class="line">08-将ca.crt等 Master节点的重要信息，通过ConfigMap的方式保存在etcd中，工后续部署node节点使用</span><br><span class="line"></span><br><span class="line">09-最后一步是安装默认插件，kubernetes默认kube-proxy和DNS两个插件是必须安装的</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2)初始化master节点</p>
<p>官网：<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm/</a></p>
<p><code>注意</code>：<strong>此操作是在主节点上进行</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 本地有镜像</span><br><span class="line">kubeadm init --kubernetes-version=1.14.0 --apiserver-advertise-address=192.168.8.51 --pod-network-cidr=10.244.0.0/16</span><br><span class="line">【若要重新初始化集群状态：kubeadm reset，然后再进行上述操作】</span><br></pre></td></tr></table></figure>

<p><strong>记得保存好最后kubeadm join的信息</strong></p>
<blockquote>
<p>(3)根据日志提示</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<p><strong>此时kubectl cluster-info查看一下是否成功</strong></p>
<blockquote>
<p>(4)查看pod验证一下</p>
<p>等待一会儿，同时可以发现像etc，controller，scheduler等组件都以pod的方式安装成功了</p>
<p><code>注意</code>：coredns没有启动，需要安装网络插件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(5)健康检查</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -k https://localhost:6443/healthz</span><br></pre></td></tr></table></figure>

<h2 id="1-10-部署calico网络插件"><a href="#1-10-部署calico网络插件" class="headerlink" title="1.10 部署calico网络插件"></a>1.10 部署calico网络插件</h2><blockquote>
<p>选择网络插件：<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p>
<p>calico网络插件：<a href="https://docs.projectcalico.org/v3.9/getting-started/kubernetes/" target="_blank" rel="noopener">https://docs.projectcalico.org/v3.9/getting-started/kubernetes/</a></p>
</blockquote>
<blockquote>
<p><code>calico，同样在master节点上操作</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 在k8s中安装calico</span><br><span class="line">kubectl apply -f https://docs.projectcalico.org/v3.9/manifests/calico.yaml</span><br><span class="line"></span><br><span class="line"># 确认一下calico是否安装成功</span><br><span class="line">kubectl get pods --all-namespaces -w</span><br></pre></td></tr></table></figure>

<h2 id="1-11-kube-join"><a href="#1-11-kube-join" class="headerlink" title="1.11 kube join"></a>1.11 kube join</h2><blockquote>
<p><strong>记得保存初始化master节点的最后打印信息【注意这边大家要自己的，下面我的只是一个参考】</strong></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.0.51:6443 --token yu1ak0.2dcecvmpozsy8loh \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:5c4a69b3bb05b81b675db5559b0e4d7972f1d0a61195f217161522f464c307b0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(1)在woker01和worker02上执行上述命令</p>
</blockquote>
<blockquote>
<p>(2)在master节点上检查集群信息</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br><span class="line"></span><br><span class="line">NAME                   STATUS   ROLES    AGE     VERSION</span><br><span class="line">master-kubeadm-k8s     Ready    master   19m     v1.14.0</span><br><span class="line">worker01-kubeadm-k8s   Ready    &lt;none&gt;   3m6s    v1.14.0</span><br><span class="line">worker02-kubeadm-k8s   Ready    &lt;none&gt;   2m41s   v1.14.0</span><br></pre></td></tr></table></figure>

<h2 id="1-12-再次体验Pod"><a href="#1-12-再次体验Pod" class="headerlink" title="1.12 再次体验Pod"></a>1.12 再次体验Pod</h2><blockquote>
<p>(1)定义pod.yml文件，比如pod_nginx_rs.yaml</p>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">&gt; pod_nginx_rs.yaml &lt;&lt;EOF</span></span><br><span class="line"><span class="string"></span><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">3</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2)根据pod_nginx_rs.yml文件创建pod</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod_nginx_rs.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(3)查看pod</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods</span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">kubectl describe pod nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(4)感受通过rs将pod扩容</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale rs nginx --replicas=5</span><br><span class="line">kubectl get pods -o wide</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(5)删除pod</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f pod_nginx_rs.yaml</span><br></pre></td></tr></table></figure>

<h1 id="02-Basic"><a href="#02-Basic" class="headerlink" title="02 Basic"></a>02 Basic</h1><h2 id="2-1-yaml文件"><a href="#2-1-yaml文件" class="headerlink" title="2.1 yaml文件"></a>2.1 yaml文件</h2><h3 id="2-1-1-简介"><a href="#2-1-1-简介" class="headerlink" title="2.1.1 简介"></a>2.1.1 简介</h3><p>YAML（IPA: /ˈjæməl/）是一个可读性高的语言，参考了XML、C、Python等。</p>
<p>理解：Yet Another Markup Language</p>
<p>后缀：可以是.yml或者是.yaml，更加推荐.yaml，其实用任意后缀都可以，只是阅读性不强</p>
<h3 id="2-1-2-基础"><a href="#2-1-2-基础" class="headerlink" title="2.1.2 基础"></a>2.1.2 基础</h3><ul>
<li>区分大小写</li>
<li>缩进表示层级关系，相同层级的元素左对齐</li>
<li>缩进只能使用空格，不能使用TAB</li>
<li>“#”表示当前行的注释</li>
<li>是JSON文件的超级，两个可以转换</li>
<li>—表示分隔符，可以在一个文件中定义多个结构</li>
<li>使用key: value，其中”:”和value之间要有一个英文空格</li>
</ul>
<h3 id="2-1-3-Maps"><a href="#2-1-3-Maps" class="headerlink" title="2.1.3 Maps"></a>2.1.3 Maps</h3><h4 id="2-1-3-1-简单"><a href="#2-1-3-1-简单" class="headerlink" title="2.1.3.1 简单"></a>2.1.3.1 简单</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>—表示分隔符，可选。要定义多个结构一定要分隔</p>
<p>apiVersion表示key，v1表示value，英文”:”后面要有一个空格</p>
<p>kind表示key，Pod表示value</p>
<p>也可以这样写apiVersion: “v1”</p>
<p><code>转换为JSON格式</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt; "apiVersion": "v1",</span><br><span class="line">&gt; "kind": "Pod"</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<h4 id="2-1-2-2-复杂"><a href="#2-1-2-2-复杂" class="headerlink" title="2.1.2.2 复杂"></a>2.1.2.2 复杂</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>metadata表示key，下面的内容表示value，该value中包含两个直接的key：name和labels</p>
<p>name表示key，nginx-deployment表示value</p>
<p>labels表示key，下面的表示value，这个值又是一个map</p>
<p>app表示key，nginx表示value</p>
<p>相同层级的记得使用空间缩进，左对齐</p>
<p><code>转换为JSON格式</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt; "apiVersion": "apps/v1",</span><br><span class="line">&gt; "kind": "Deployment",</span><br><span class="line">&gt; "metadata": &#123;</span><br><span class="line">&gt;             "name": "nginx-deployment",</span><br><span class="line">&gt;             "labels": &#123;</span><br><span class="line">&gt;                        "app": "nginx"</span><br><span class="line">&gt;                       &#125;</span><br><span class="line">&gt;            &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="2-1-4-Lists"><a href="#2-1-4-Lists" class="headerlink" title="2.1.4 Lists"></a>2.1.4 Lists</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">myapp-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">myapp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp-container01</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.28</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">myapp-container02</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">busybox:1.28</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>containers表示key，下面的表示value，其中value是一个数组</p>
<p>数组中有两个元素，每个元素里面包含name和image</p>
<p>image表示key，myapp-container表示value</p>
<p><code>转换成JSON格式</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; &#123;</span><br><span class="line">&gt; "apiVersion": "v1",</span><br><span class="line">&gt; "kind": "Pod",</span><br><span class="line">&gt; "metadata": &#123;</span><br><span class="line">&gt;               "name": "myapp",</span><br><span class="line">&gt;               "labels": &#123;</span><br><span class="line">&gt;                           "app": "myapp"</span><br><span class="line">&gt;                         &#125;</span><br><span class="line">&gt;             &#125;,</span><br><span class="line">&gt;  "spec": &#123;</span><br><span class="line">&gt;     "containers": [&#123;</span><br><span class="line">&gt;                     "name": "myapp-container01",</span><br><span class="line">&gt;                     "image": "busybox:1.28",</span><br><span class="line">&gt;                    &#125;, </span><br><span class="line">&gt;                    &#123;</span><br><span class="line">&gt;                     "name": "myapp-container02",</span><br><span class="line">&gt;                     "image": "busybox:1.28",</span><br><span class="line">&gt;                    &#125;]</span><br><span class="line">&gt;          &#125;</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="2-1-5-找个k8s的yaml文件"><a href="#2-1-5-找个k8s的yaml文件" class="headerlink" title="2.1.5 找个k8s的yaml文件"></a>2.1.5 找个k8s的yaml文件</h3><blockquote>
<p><code>官网</code>：<a href="https://kubernetes.io/docs/reference/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/</a></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yaml格式对于Pod的定义：</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span>          <span class="comment">#必写，版本号，比如v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>               <span class="comment">#必写，类型，比如Pod</span></span><br><span class="line"><span class="attr">metadata:</span>               <span class="comment">#必写，元数据</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx</span>           <span class="comment">#必写，表示pod名称</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span>    <span class="comment">#表示pod名称属于的命名空间</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span>                  <span class="comment">#自定义标签名字</span></span><br><span class="line"><span class="attr">spec:</span>                           <span class="comment">#必写，pod中容器的详细定义</span></span><br><span class="line"><span class="attr">  containers:</span>                   <span class="comment">#必写，pod中容器列表</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx</span>                 <span class="comment">#必写，容器名称</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">nginx</span>                <span class="comment">#必写，容器的镜像名称</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">80</span>         <span class="comment">#表示容器的端口</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-Container"><a href="#2-2-Container" class="headerlink" title="2.2 Container"></a>2.2 Container</h2><blockquote>
<p><code>官网</code>：<a href="https://kubernetes.io/docs/concepts/containers/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/containers/</a></p>
</blockquote>
<h3 id="2-2-1-Docker世界中"><a href="#2-2-1-Docker世界中" class="headerlink" title="2.2.1 Docker世界中"></a>2.2.1 Docker世界中</h3><p>可以通过docker run运行一个容器</p>
<p>或者定义一个yml文件，本机使用docker-compose，多机通过docker swarm创建</p>
<h3 id="2-2-2-K8S世界中"><a href="#2-2-2-K8S世界中" class="headerlink" title="2.2.2 K8S世界中"></a>2.2.2 K8S世界中</h3><p>同样以一个yaml文件维护，container运行在pod中</p>
<h2 id="2-3-Pod"><a href="#2-3-Pod" class="headerlink" title="2.3 Pod"></a>2.3 Pod</h2><blockquote>
<p><code>官网</code>：<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/</a></p>
</blockquote>
<h3 id="2-3-1-What-is-Pod"><a href="#2-3-1-What-is-Pod" class="headerlink" title="2.3.1 What is Pod"></a>2.3.1 What is Pod</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A Pod is the basic execution unit of a Kubernetes application</span><br><span class="line">A Pod encapsulates an application’s container (or, in some cases, multiple containers), storage resources, a unique network IP, and options that govern how the container(s) should run</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2-Pod初体验"><a href="#2-3-2-Pod初体验" class="headerlink" title="2.3.2 Pod初体验"></a>2.3.2 Pod初体验</h3><blockquote>
<p>(1)创建一个pod的yaml文件，名称为nginx_pod.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nginx-pod</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">nginx-container</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="attr">    - containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>(2)根据该nginx_pod.yaml文件创建pod</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx_pod.yaml</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(3)查看pod</p>
</blockquote>
<p>01 kubectl get pods</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-pod   1/1     Running   0          29s</span><br></pre></td></tr></table></figure>

<p>02 kubectl get pods -o wide</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAME       READY     STATUS   RESTARTS   AGE             IP             NODE   </span><br><span class="line">nginx-pod   1/1     Running      0       40m       192.168.80.194        w2</span><br></pre></td></tr></table></figure>

<p>03 kubectl describe pod nginx-pod</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Name:               nginx-pod</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               w2/192.168.0.62</span><br><span class="line">Start Time:         Sun, 06 Oct 2019 20:45:35 +0000</span><br><span class="line">Labels:             app=nginx</span><br><span class="line">Annotations:        cni.projectcalico.org/podIP: 192.168.80.194/32</span><br><span class="line">                    kubectl.kubernetes.io/last-applied-configuration:</span><br><span class="line">                      &#123;&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Pod&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;labels&quot;:&#123;&quot;app&quot;:&quot;nginx&quot;&#125;,&quot;name&quot;:&quot;nginx-pod&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;c...</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 192.168.80.194</span><br><span class="line">Containers:</span><br><span class="line">  nginx-container:</span><br><span class="line">    Container ID:   docker://eb2fd0b2906f53e9892e22a6fd791c9ac68fb8e5efce3bbf94ec12bae96e1984</span><br><span class="line">    Image:          nginx</span><br><span class="line">    Image ID:       docker-pullable:/</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(4)可以发现该pod运行在worker02节点上</p>
</blockquote>
<p>于是来到worker02节点，docker ps一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER ID  IMAGE  COMMAND                    CREATED        STATUS   PORTS   NAMES</span><br><span class="line">eb2fd0b2906f  nginx  &quot;nginx -g &apos;daemon of…&quot;   6 minutes ago       Up 6 minutes           k8s_nginx-container_nginx-pod_default_3ee0706d-e87a-11e9-a904-5254008afee6_0</span><br></pre></td></tr></table></figure>

<p>不妨进入该容器试试[可以发现只有在worker02上有该容器，因为pod运行在worker02上]：</p>
<p>docker exec -it k8s_nginx-container_nginx-pod_default_3ee0706d-e87a-11e9-a904-5254008afee6_0 bash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@nginx-pod:/#</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(5)访问nginx容器</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 192.168.80.194    OK，并且在任何一个集群中的Node上访问都成功</span><br></pre></td></tr></table></figure>

<blockquote>
<p>(6)删除Pod</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f nginx_pod.yaml</span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<h3 id="2-3-3-Storage-and-Networking"><a href="#2-3-3-Storage-and-Networking" class="headerlink" title="2.3.3 Storage and Networking"></a>2.3.3 Storage and Networking</h3><blockquote>
<p><code>官网</code>：<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#networking" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#networking</a></p>
</blockquote>
<ul>
<li>Networking</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Each Pod is assigned a unique IP address. Every container in a Pod shares the network namespace, including the IP address and network ports.</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>官网</code>：<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#storage" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/#storage</a></p>
</blockquote>
<ul>
<li>Storage</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A Pod can specify a set of shared storage Volumes. All containers in the Pod can access the shared volumes, allowing those containers to share data.</span><br></pre></td></tr></table></figure>

</section>
    <!-- Tags START -->
    
      <div class="tags">
        <span>Tags:</span>
        
  <a href="/tags#k8s" >
    <span class="tag-code">k8s</span>
  </a>

      </div>
    
    <!-- Tags END -->
    <!-- NAV START -->
    
  <div class="nav-container">
    <!-- reverse left and right to put prev and next in a more logic postition -->
    
      <a class="nav-left" href="/2020/01/02/15779734658571/">
        <span class="nav-arrow">← </span>
        
          protobuf 使用总结
        
      </a>
    
    
      <a class="nav-right" href="/2020/01/17/15792347490911/">
        
          宏观上了解k8s
        
        <span class="nav-arrow"> →</span>
      </a>
    
  </div>

    <!-- NAV END -->
    <!-- 打赏 START -->
    
    <!-- 打赏 END -->
    <!-- 二维码 START -->
    
    <!-- 二维码 END -->
    
      <!-- Gitment START -->
      <div id="comments"></div>
      <!-- Gitment END -->
    
  </article>
  <!-- Article END -->
  <!-- Catalog START -->
  
    <aside class="catalog-container">
  <div class="toc-main">
    <strong class="toc-title">Catalog</strong>
    
      <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#01-搭建K8s集群-无需科学上网"><span class="toc-nav-text">01 搭建K8s集群[无需科学上网]</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-1-版本统一"><span class="toc-nav-text">1.1 版本统一</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-2-准备3台centos"><span class="toc-nav-text">1.2 准备3台centos</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-3-更新并安装依赖"><span class="toc-nav-text">1.3 更新并安装依赖</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-4-安装Docker"><span class="toc-nav-text">1.4 安装Docker</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-5-修改hosts文件"><span class="toc-nav-text">1.5 修改hosts文件</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-6-系统基础前提配置"><span class="toc-nav-text">1.6 系统基础前提配置</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-7-Installing-kubeadm-kubelet-and-kubectl"><span class="toc-nav-text">1.7 Installing kubeadm, kubelet and kubectl</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-8-proxy-pause-scheduler等国内镜像"><span class="toc-nav-text">1.8 proxy/pause/scheduler等国内镜像</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-9-kube-init初始化master"><span class="toc-nav-text">1.9 kube init初始化master</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-10-部署calico网络插件"><span class="toc-nav-text">1.10 部署calico网络插件</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-11-kube-join"><span class="toc-nav-text">1.11 kube join</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#1-12-再次体验Pod"><span class="toc-nav-text">1.12 再次体验Pod</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#02-Basic"><span class="toc-nav-text">02 Basic</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-1-yaml文件"><span class="toc-nav-text">2.1 yaml文件</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-1-简介"><span class="toc-nav-text">2.1.1 简介</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-2-基础"><span class="toc-nav-text">2.1.2 基础</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-3-Maps"><span class="toc-nav-text">2.1.3 Maps</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-1-3-1-简单"><span class="toc-nav-text">2.1.3.1 简单</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#2-1-2-2-复杂"><span class="toc-nav-text">2.1.2.2 复杂</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-4-Lists"><span class="toc-nav-text">2.1.4 Lists</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-1-5-找个k8s的yaml文件"><span class="toc-nav-text">2.1.5 找个k8s的yaml文件</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-2-Container"><span class="toc-nav-text">2.2 Container</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-2-1-Docker世界中"><span class="toc-nav-text">2.2.1 Docker世界中</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-2-2-K8S世界中"><span class="toc-nav-text">2.2.2 K8S世界中</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#2-3-Pod"><span class="toc-nav-text">2.3 Pod</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-3-1-What-is-Pod"><span class="toc-nav-text">2.3.1 What is Pod</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-3-2-Pod初体验"><span class="toc-nav-text">2.3.2 Pod初体验</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#2-3-3-Storage-and-Networking"><span class="toc-nav-text">2.3.3 Storage and Networking</span></a></li></ol></li></ol></li></ol>
    
  </div>
</aside>
  
  <!-- Catalog END -->
</main>

<script>
  (function () {
    var url = 'http://yoursite.com/2020/01/13/15788833836416/';
    var banner = ''
    if (banner !== '' && banner !== 'undefined' && banner !== 'null') {
      $('#article-banner').css({
        'background-image': 'url(' + banner + ')'
      })
    } else {
      $('#article-banner').geopattern(url)
    }
    $('.header').removeClass('fixed-header')

    // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png')
      $(this).css({
        'cursor': 'default'
      })
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      if (src !== 'http://file.muyutech.com/error-img.png') {
        var imageW = $(this).width()
        var imageH = $(this).height()

        var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
        zoom = zoom < 1 ? 1 : zoom
        zoom = zoom > 2 ? 2 : zoom
        var transY = (($(window).height() - imageH) / 2).toFixed(2)

        $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
        $('.image-view-wrap').addClass('wrap-active')
        $('.image-view-wrap img').css({
          'width': `${imageW}`,
          'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
        })
        $('html').css('overflow', 'hidden')

        $('.image-view-wrap').on('click', function() {
          $(this).remove()
          $('html').attr('style', '')
        })
      }
    })
  })();
</script>




  <script>
    var gitmentConfig = "weletry";
    if (gitmentConfig !== 'undefined') {
      var gitment = new Gitment({
        id: "",
        owner: "weletry",
        repo: "weletry.github.io",
        oauth: {
          client_id: "58a8359827da27b34578",
          client_secret: "b2ec69e99ca304bb72462bc6623c8205adff4c87"
        },
        theme: {
          render(state, instance) {
            const container = document.createElement('div')
            container.lang = "en-US"
            container.className = 'gitment-container gitment-root-container'
            container.appendChild(instance.renderHeader(state, instance))
            container.appendChild(instance.renderEditor(state, instance))
            container.appendChild(instance.renderComments(state, instance))
            container.appendChild(instance.renderFooter(state, instance))
            return container;
          }
        }
      })
      gitment.render(document.getElementById('comments'))
    }
  </script>




    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2020 | Proudly powered by <a href="https://hexo.io" target="_blank">Hexo</a>
    <br>
    Theme by <a href="https://github.com/weletry">weletry</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
    FastClick.attach(document.body);
  })
</script>

<script>
  var hasLine = 'true';
  async("//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js", function(){
    $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine === 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
  })
</script>
<!-- Baidu Tongji -->

<script src="/js/script.js"></script>
  </body>
</html>